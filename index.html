<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Viva Master | Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-cog mr-2 text-blue-600"></i>Settings</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600 transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="Paste your API key here..." 
                            class="w-full pl-4 pr-10 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition">
                        <button onclick="togglePasswordVisibility()" class="absolute right-3 top-3.5 text-slate-400 hover:text-slate-600">
                            <i id="eyeIcon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">
                        <i class="fa-solid fa-shield-halved mr-1"></i> Your key is saved locally in your browser.
                    </p>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md hover:shadow-lg w-full sm:w-auto">
                    Save & Close
                </button>
            </div>
        </div>
    </div>

    <main class="w-full max-w-4xl bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 flex flex-col h-[85vh] md:h-[800px]">
        
        <header class="bg-white border-b border-slate-100 p-6 flex justify-between items-center shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                    <i class="fa-solid fa-robot text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-800 tracking-tight">AI Viva Master</h1>
                    <p class="text-xs text-slate-500 font-medium">Powered by Gemini 2.5 Flash</p>
                </div>
            </div>
            <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-blue-600 transition rounded-full hover:bg-slate-50">
                <i class="fa-solid fa-gear text-xl"></i>
            </button>
        </header>

        <div id="setupView" class="flex-1 flex flex-col justify-center p-8 md:p-12 overflow-y-auto">
            <div class="max-w-2xl mx-auto w-full space-y-8">
                
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-3">Ready for your Viva?</h2>
                    <p class="text-slate-500 text-lg">Configure your session settings below to begin.</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2 uppercase tracking-wide">Viva Topic</label>
                        <input type="text" id="topicInput" 
                            placeholder="e.g. React Hooks, Thermodynamics, Indian History..." 
                            class="w-full p-4 text-lg border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition placeholder:text-slate-300">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 p-1 rounded-xl flex border border-slate-200">
                            <button onclick="setMode('friendly')" id="btnFriendly" class="flex-1 py-3 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600 border border-slate-200">
                                <i class="fa-solid fa-face-smile mr-2"></i>Friendly
                            </button>
                            <button onclick="setMode('strict')" id="btnStrict" class="flex-1 py-3 rounded-lg text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all">
                                <i class="fa-solid fa-user-graduate mr-2"></i>Strict
                            </button>
                        </div>

                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-language text-slate-400"></i>
                            </div>
                            <select id="languageSelect" class="w-full pl-10 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer">
                                <option value="English">English Language</option>
                                <option value="Hindi">Hindi Language</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="startViva()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-lg font-bold py-5 rounded-xl shadow-lg hover:shadow-xl transform transition hover:-translate-y-0.5 active:translate-y-0 flex items-center justify-center gap-3">
                    <span>Start Interview</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <p id="errorMsg" class="text-red-500 text-center text-sm font-medium hidden flex items-center justify-center gap-2">
                    <i class="fa-solid fa-circle-exclamation"></i> <span></span>
                </p>
            </div>
        </div>

        <div id="vivaView" class="hidden flex-1 flex flex-col h-full relative">
            
            <div id="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth bg-slate-50/50">
                </div>

            <div id="loadingIndicator" class="hidden px-6 pb-2">
                <div class="flex items-center gap-2 bg-white px-4 py-3 rounded-2xl rounded-tl-none border border-slate-100 shadow-sm w-fit">
                    <div class="typing-dot w-2 h-2 bg-slate-400 rounded-full"></div>
                    <div class="typing-dot w-2 h-2 bg-slate-400 rounded-full"></div>
                    <div class="typing-dot w-2 h-2 bg-slate-400 rounded-full"></div>
                </div>
            </div>

            <div class="bg-white p-4 md:p-6 border-t border-slate-100 shrink-0">
                <div class="max-w-3xl mx-auto flex items-center gap-4">
                    
                    <button onclick="endSession()" class="shrink-0 w-12 h-12 rounded-full border border-slate-200 text-slate-500 hover:bg-slate-100 hover:text-red-500 transition flex items-center justify-center" title="End Session">
                        <i class="fa-solid fa-power-off"></i>
                    </button>

                    <div class="flex-1 relative">
                        <input type="text" id="userResponseInput" placeholder="Type your answer here..." 
                            class="w-full pl-5 pr-14 py-4 bg-slate-50 border border-slate-200 rounded-full focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition"
                            onkeypress="handleEnter(event)">
                        
                        <button onclick="sendTextResponse()" class="absolute right-2 top-2 w-10 h-10 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex items-center justify-center shadow-md transition">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>

                    <button id="micBtn" onclick="toggleSpeech()" class="shrink-0 w-14 h-14 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-700 transition flex items-center justify-center shadow-sm border border-slate-200 relative overflow-visible">
                        <i class="fa-solid fa-microphone text-xl"></i>
                    </button>

                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION & STATE ---
        const CONFIG = {
            model: "gemini-1.5-flash", // Using stable Flash model (often aliased for speed)
            apiUrl: "https://generativelanguage.googleapis.com/v1beta/models/"
        };

        let state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            topic: '',
            mode: 'friendly', // friendly | strict
            language: 'English',
            isListening: false,
            history: [],
            recognition: null,
            synth: window.speechSynthesis
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('apiKeyInput').value = state.apiKey;
            initSpeechRecognition();
        });

        // --- SETTINGS MANAGEMENT ---
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                state.apiKey = key;
                localStorage.setItem('gemini_api_key', key);
                toggleSettings();
                showError(""); // Clear errors
            } else {
                alert("Please enter a valid API Key.");
            }
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('apiKeyInput');
            const icon = document.getElementById('eyeIcon');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        function setMode(mode) {
            state.mode = mode;
            const btnFriendly = document.getElementById('btnFriendly');
            const btnStrict = document.getElementById('btnStrict');
            
            if (mode === 'friendly') {
                btnFriendly.className = "flex-1 py-3 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-blue-600 border border-slate-200";
                btnStrict.className = "flex-1 py-3 rounded-lg text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all";
            } else {
                btnStrict.className = "flex-1 py-3 rounded-lg text-sm font-semibold transition-all shadow-sm bg-white text-red-600 border border-slate-200";
                btnFriendly.className = "flex-1 py-3 rounded-lg text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all";
            }
        }

        // --- CORE LOGIC: START VIVA ---
        function startViva() {
            // 1. Validation Logic
            const errorMsgEl = document.getElementById('errorMsg');
            const topicInput = document.getElementById('topicInput'); // Correctly targeting ID
            
            // Step A: Check API Key
            if (!state.apiKey) {
                showError("Please click the ⚙️ icon and enter your Gemini API Key first.");
                toggleSettings(); // Auto-open settings for UX
                return;
            }

            // Step B: Check Topic
            const topicValue = topicInput.value.trim();
            if (!topicValue) {
                showError("Please enter a Viva Topic to begin.");
                topicInput.focus();
                topicInput.classList.add('ring-2', 'ring-red-200', 'border-red-400');
                setTimeout(() => topicInput.classList.remove('ring-2', 'ring-red-200', 'border-red-400'), 2000);
                return;
            }

            // 2. State Update
            state.topic = topicValue;
            state.language = document.getElementById('languageSelect').value;
            state.history = []; // Reset history
            
            // 3. UI Transition
            document.getElementById('setupView').classList.add('hidden');
            document.getElementById('vivaView').classList.remove('hidden');
            document.getElementById('vivaView').classList.add('flex');
            
            // 4. Initial Prompt Generation
            initiateAIConversation();
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            if(msg) {
                el.querySelector('span').innerText = msg;
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // --- AI INTEGRATION ---
        async function initiateAIConversation() {
            const systemPrompt = `You are a strict but fair Viva Examiner. 
            Topic: ${state.topic}. 
            Mode: ${state.mode}. 
            Language: ${state.language} (Respond in this language).
            
            Start by introducing yourself briefly and asking the first conceptual question about ${state.topic}. 
            Keep questions concise (1-2 sentences). Wait for the user's answer before asking the next.`;
            
            // Add system prompt to history (conceptually, for Gemini API we usually just send history)
            // For this implementation, we will treat the first message as the trigger.
            
            addMessageToUI("system", `Starting Viva on ${state.topic}...`);
            await fetchGeminiResponse([{ role: "user", parts: [{ text: systemPrompt }] }]);
        }

        async function fetchGeminiResponse(conversationHistory) {
            const loading = document.getElementById('loadingIndicator');
            loading.classList.remove('hidden');
            
            try {
                const url = `${CONFIG.apiUrl}${CONFIG.model}:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: conversationHistory,
                    generationConfig: {
                        temperature: state.mode === 'strict' ? 0.3 : 0.7,
                        maxOutputTokens: 300
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                loading.classList.add('hidden');

                if (data.error) throw new Error(data.error.message);

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Update History
                state.history.push({ role: "model", parts: [{ text: aiText }] });
                
                // UI & Audio
                addMessageToUI("ai", aiText);
                speakText(aiText);

            } catch (error) {
                loading.classList.add('hidden');
                addMessageToUI("system", "Error: " + error.message);
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendTextResponse();
        }

        async function sendTextResponse() {
            const input = document.getElementById('userResponseInput');
            const text = input.value.trim();
            if (!text) return;

            addMessageToUI("user", text);
            input.value = '';

            // Add to history and call AI
            state.history.push({ role: "user", parts: [{ text: text }] });
            
            // Construct full context for the API (last few turns to save tokens/complexity, or full history)
            // Ideally send full history for context retention
            await fetchGeminiResponse(state.history);
        }

        // --- UI HELPER FUNCTIONS ---
        function addMessageToUI(role, text) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            
            if (role === 'ai') {
                div.className = "flex gap-3 max-w-[85%]";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-600 to-indigo-600 flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>
                    <div class="bg-white border border-slate-200 p-4 rounded-2xl rounded-tl-none text-slate-700 shadow-sm leading-relaxed">
                        ${text}
                    </div>
                `;
            } else if (role === 'user') {
                div.className = "flex gap-3 max-w-[85%] ml-auto flex-row-reverse";
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-slate-500 text-xs"><i class="fa-solid fa-user"></i></div>
                    <div class="bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md leading-relaxed">
                        ${text}
                    </div>
                `;
            } else {
                // System message
                div.className = "flex justify-center my-2";
                div.innerHTML = `<span class="text-xs font-medium text-slate-400 bg-slate-100 px-3 py-1 rounded-full">${text}</span>`;
            }

            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- SPEECH RECOGNITION & SYNTHESIS ---
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                state.recognition = new webkitSpeechRecognition();
                state.recognition.continuous = false;
                state.recognition.interimResults = false;
                
                state.recognition.onstart = () => {
                    state.isListening = true;
                    const btn = document.getElementById('micBtn');
                    btn.classList.add('bg-red-50', 'text-red-600', 'pulse-ring');
                    btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
                };

                state.recognition.onend = () => {
                    state.isListening = false;
                    resetMicButton();
                };

                state.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userResponseInput').value = transcript;
                    sendTextResponse(); // Auto send on speak
                };
            } else {
                document.getElementById('micBtn').style.display = 'none';
                console.warn("Speech Recognition not supported in this browser.");
            }
        }

        function toggleSpeech() {
            if (!state.recognition) return;
            
            // Set language dynamically
            state.recognition.lang = state.language === 'Hindi' ? 'hi-IN' : 'en-US';

            if (state.isListening) {
                state.recognition.stop();
            } else {
                state.recognition.start();
            }
        }

        function resetMicButton() {
            const btn = document.getElementById('micBtn');
            btn.classList.remove('bg-red-50', 'text-red-600', 'pulse-ring');
            btn.innerHTML = '<i class="fa-solid fa-microphone text-xl"></i>';
        }

        function speakText(text) {
            // Cancel any ongoing speech
            state.synth.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = state.language === 'Hindi' ? 'hi-IN' : 'en-US';
            utterance.rate = 1; // Normal speed
            state.synth.speak(utterance);
        }

        function endSession() {
            if(confirm("End the Viva session?")) {
                location.reload();
            }
        }
    </script>
</body>
</html>
