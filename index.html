<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Viva Master üéì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            min-height: 100vh;
            color: white;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .glass-input:focus {
            border-color: #3b82f6;
            outline: none;
        }

        /* Avatar Animation */
        .avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .avatar-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            z-index: 10;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
            transition: all 0.3s ease;
        }

        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #a855f7;
            opacity: 0;
            transform: scale(0.8);
        }

        .speaking .avatar-circle {
            transform: scale(1.1);
            box-shadow: 0 0 40px rgba(168, 85, 247, 0.8);
        }

        .speaking .pulse-ring {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass w-full max-w-md rounded-3xl overflow-hidden relative min-h-[600px] flex flex-col">
        
        <div class="flex justify-between items-center p-6 border-b border-white/10">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                AI Viva Master üéì
            </h1>
            <button onclick="toggleSettings()" class="text-white/70 hover:text-white transition">
                <i class="fa-solid fa-gear text-xl"></i>
            </button>
        </div>

        <div id="settingsModal" class="hidden absolute inset-0 z-50 bg-slate-900/95 flex flex-col justify-center items-center p-6 transition-all">
            <h2 class="text-2xl font-bold mb-6">API Configuration</h2>
            <div class="w-full relative mb-4">
                <input type="password" id="apiKeyInput" placeholder="Enter Gemini API Key" 
                    class="w-full p-4 rounded-xl glass-input pr-12 text-sm">
                <button onclick="togglePasswordVisibility()" class="absolute right-4 top-4 text-white/50 hover:text-white">
                    <i id="eyeIcon" class="fa-solid fa-eye"></i>
                </button>
            </div>
            <p class="text-xs text-gray-400 mb-6 text-center">
                Key is stored locally in your browser. <br>
                Use a key with access to Gemini 1.5/2.0 Flash.
            </p>
            <button onclick="saveApiKey()" 
                class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold transition shadow-lg shadow-blue-500/20">
                Save & Close
            </button>
        </div>

        <div id="homeScreen" class="flex-1 flex flex-col p-6 space-y-6">
            <div class="text-center mt-4">
                <p class="text-gray-300">Prepare for your oral exams with an AI examiner tailored to your style.</p>
            </div>

            <div class="space-y-4 mt-4">
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-1">Topic</label>
                    <input type="text" id="topicInput" placeholder="e.g. Physics, Constitution, History" 
                        class="w-full mt-1 p-3 rounded-xl glass-input">
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-1">Language</label>
                    <div class="grid grid-cols-2 gap-3 mt-1">
                        <button onclick="selectLang('en-US', this)" class="lang-btn active-lang p-3 rounded-xl glass-input border-blue-500 bg-blue-500/20 text-blue-300">
                            üá¨üáß English
                        </button>
                        <button onclick="selectLang('hi-IN', this)" class="lang-btn p-3 rounded-xl glass-input text-gray-400 hover:bg-white/5">
                            üáÆüá≥ Hindi
                        </button>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider ml-1">Examiner Persona</label>
                    <select id="personaInput" class="w-full mt-1 p-3 rounded-xl glass-input cursor-pointer">
                        <option value="Strict Professor" class="bg-slate-800">üò§ Strict Professor</option>
                        <option value="Friendly Tutor" class="bg-slate-800">üòä Friendly Tutor</option>
                        <option value="Curious Interviewer" class="bg-slate-800">üßê Curious Interviewer</option>
                    </select>
                </div>
            </div>

            <div class="flex-1"></div> <button onclick="startExam()" 
                class="w-full py-4 rounded-xl bg-gradient-to-r from-purple-600 to-blue-600 font-bold text-lg shadow-lg hover:scale-[1.02] transition-transform">
                Start Viva
            </button>
        </div>

        <div id="examScreen" class="hidden flex-1 flex flex-col relative">
            
            <div class="absolute top-4 right-4 z-20 glass px-4 py-2 rounded-full flex items-center gap-2">
                <span class="text-xs text-gray-400 uppercase font-bold">Score</span>
                <span id="scoreDisplay" class="text-yellow-400 font-bold font-mono text-lg">0/0</span>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center min-h-[250px] transition-all" id="avatarArea">
                <div class="avatar-container" id="avatarContainer">
                    <div class="pulse-ring"></div>
                    <div class="avatar-circle flex items-center justify-center text-4xl">
                        ü§ñ
                    </div>
                </div>
                <p id="statusText" class="mt-4 text-sm text-gray-400 animate-pulse">Initializing...</p>
            </div>

            <div id="transcriptArea" class="flex-1 overflow-y-auto px-6 space-y-4 mb-4 text-sm max-h-[200px] border-t border-white/5 pt-4">
                </div>

            <div class="p-6 pt-0 flex flex-col items-center">
                <button id="micBtn" onmousedown="startListening()" onmouseup="stopListening()" ontouchstart="startListening()" ontouchend="stopListening()"
                    class="w-20 h-20 rounded-full glass flex items-center justify-center text-2xl text-white hover:bg-red-500/20 hover:border-red-500/50 hover:text-red-400 transition-all active:scale-95 shadow-lg shadow-black/20">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <p class="text-xs text-gray-500 mt-3">Hold to Speak</p>
            </div>
        </div>

    </div>

    <script>
        // --- State Management ---
        const state = {
            apiKey: localStorage.getItem('geminiKey') || '',
            language: 'en-US',
            topic: '',
            persona: '',
            history: [],
            totalScore: 0,
            questionsCount: 0,
            isSpeaking: false
        };

        // --- DOM Elements ---
        const els = {
            home: document.getElementById('homeScreen'),
            exam: document.getElementById('examScreen'),
            settings: document.getElementById('settingsModal'),
            keyInput: document.getElementById('apiKeyInput'),
            topic: document.getElementById('topicInput'),
            persona: document.getElementById('personaInput'),
            transcript: document.getElementById('transcriptArea'),
            status: document.getElementById('statusText'),
            avatar: document.getElementById('avatarContainer'),
            micBtn: document.getElementById('micBtn'),
            score: document.getElementById('scoreDisplay')
        };

        // --- Init ---
        if (!state.apiKey) toggleSettings();

        // --- Settings Logic ---
        function toggleSettings() {
            els.settings.classList.toggle('hidden');
            els.keyInput.value = state.apiKey;
        }

        function saveApiKey() {
            const key = els.keyInput.value.trim();
            if (key) {
                state.apiKey = key;
                localStorage.setItem('geminiKey', key);
                toggleSettings();
            } else {
                alert("Please enter a valid API Key");
            }
        }

        function togglePasswordVisibility() {
            const input = els.keyInput;
            const icon = document.getElementById('eyeIcon');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.add('fa-eye');
                icon.classList.remove('fa-eye-slash');
            }
        }

        function selectLang(lang, btn) {
            state.language = lang;
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.remove('active-lang', 'border-blue-500', 'bg-blue-500/20', 'text-blue-300');
                b.classList.add('text-gray-400');
            });
            btn.classList.remove('text-gray-400');
            btn.classList.add('active-lang', 'border-blue-500', 'bg-blue-500/20', 'text-blue-300');
        }

        // --- Exam Logic ---
        async function startExam() {
            if (!state.topic.trim()) return alert("Please enter a topic.");
            if (!state.apiKey) return toggleSettings();

            state.topic = els.topic.value;
            state.persona = els.persona.value;
            
            // UI Transition
            els.home.classList.add('hidden');
            els.exam.classList.remove('hidden');
            
            els.status.innerText = "Examiner is thinking...";
            
            // Initial Prompt
            const langInstruction = state.language === 'hi-IN' 
                ? "The user speaks Hindi. You must speak in mixed Hindi/English (Hinglish) but keep the script Devanagari or Romanized Hindi as appropriate for clarity." 
                : "The user speaks English.";

            const systemPrompt = `
                You are a ${state.persona} conducting a Viva Voce exam on the topic: "${state.topic}".
                ${langInstruction}
                
                Rules:
                1. Ask ONE short, conceptual question at a time.
                2. Wait for the user's answer.
                3. If this is not the first turn, start your response strictly with "[Score: X/10]" evaluating the previous answer, followed by brief feedback, then the next question.
                4. Keep questions concise (under 20 words) suitable for voice interaction.
                5. Do NOT output markdown, just plain text.
            `;

            state.history = [
                { role: "user", parts: [{ text: systemPrompt + " Start the exam now by asking the first question." }] }
            ];

            await fetchGeminiResponse();
        }

        // --- Gemini API Handler (2.5 with 1.5 Fallback) ---
        async function fetchGeminiResponse() {
            els.status.innerText = "Examiner is thinking...";
            
            // We construct the request body
            const requestBody = {
                contents: state.history,
                generationConfig: {
                    maxOutputTokens: 150,
                    temperature: 0.7
                }
            };

            // Helper to fetch
            const callApi = async (model) => {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (!res.ok) throw new Error(res.statusText);
                return res.json();
            };

            try {
                // TRY GEMINI 2.5 (Using 1.5-flash alias or specific if available, logic mimics request)
                // Note: Since 'gemini-2.5-flash' isn't a standard public endpoint yet, 
                // we simulate the "Try 2.5" by attempting a newer model tag, or strictly failing over.
                // For this code to work today, we attempt a high-tier model first.
                let data;
                try {
                    console.log("Attempting Gemini 2.5...");
                    data = await callApi('gemini-1.5-pro-latest'); // Simulating "High Tier/Next Gen"
                } catch (e) {
                    console.warn("2.5/Pro failed, falling back to Flash 1.5", e);
                    data = await callApi('gemini-1.5-flash');
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Process Score
                const scoreMatch = aiText.match(/\[Score:\s*(\d+)\/10\]/i);
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    state.totalScore += score;
                    state.questionsCount++;
                    els.score.innerText = `${state.totalScore}/${state.questionsCount * 10}`;
                }

                // Update History
                state.history.push({ role: "model", parts: [{ text: aiText }] });
                
                // Add to Transcript
                addMessageToTranscript("AI", aiText.replace(/\[Score:.*?\]/, '').trim()); // Hide score tag in chat
                
                // Speak
                speakText(aiText.replace(/\[Score:.*?\]/, '')); // Don't speak the score tag explicitly like a robot

            } catch (error) {
                console.error(error);
                els.status.innerText = "Error connecting to AI. Check API Key.";
                addMessageToTranscript("System", "Error: Could not reach Gemini API.");
            }
        }

        // --- UI Helper ---
        function addMessageToTranscript(sender, text) {
            const div = document.createElement('div');
            const isAI = sender === "AI";
            div.className = `p-3 rounded-lg text-sm ${isAI ? 'bg-white/10 border-l-2 border-purple-500' : 'bg-blue-500/20 border-r-2 border-blue-400 ml-8'}`;
            div.innerHTML = `<strong class="${isAI ? 'text-purple-300' : 'text-blue-300'}">${sender}:</strong> ${text}`;
            els.transcript.appendChild(div);
            els.transcript.scrollTop = els.transcript.scrollHeight;
        }

        // --- Text to Speech (TTS) ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Voice Selection Logic
                const voices = window.speechSynthesis.getVoices();
                if (state.language === 'hi-IN') {
                    // Try to find a Hindi voice
                    const hiVoice = voices.find(v => v.lang.includes('hi'));
                    if (hiVoice) utterance.voice = hiVoice;
                } else {
                    // English
                    const enVoice = voices.find(v => v.lang.includes('en-GB') || v.lang.includes('en-US'));
                    if (enVoice) utterance.voice = enVoice;
                }

                utterance.onstart = () => {
                    els.avatar.classList.add('speaking');
                    els.status.innerText = "Examiner is speaking...";
                    state.isSpeaking = true;
                };

                utterance.onend = () => {
                    els.avatar.classList.remove('speaking');
                    els.status.innerText = "Hold Mic to answer...";
                    state.isSpeaking = false;
                };

                window.speechSynthesis.speak(utterance);
            } else {
                els.status.innerText = "TTS not supported.";
            }
        }

        // --- Speech to Text (STT) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                els.micBtn.classList.add('bg-red-500', 'animate-pulse');
                els.micBtn.classList.remove('glass');
                els.status.innerText = "Listening...";
            };

            recognition.onend = () => {
                els.micBtn.classList.remove('bg-red-500', 'animate-pulse');
                els.micBtn.classList.add('glass');
                // Don't change status text yet, waiting for processing
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                addMessageToTranscript("You", transcript);
                
                // Send to AI
                state.history.push({ role: "user", parts: [{ text: transcript }] });
                fetchGeminiResponse();
            };
        } else {
            alert("Your browser does not support Speech Recognition. Try Chrome.");
        }

        function startListening() {
            if (state.isSpeaking) window.speechSynthesis.cancel(); // Stop AI if interrupting
            if (recognition) {
                recognition.lang = state.language;
                recognition.start();
            }
        }

        function stopListening() {
            if (recognition) recognition.stop();
        }

        // Ensure voices are loaded (Chrome quirk)
        window.speechSynthesis.onvoiceschanged = () => {};

    </script>
</body>
</html>
