<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium AI Vision | Gemini 2.5 Flash</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Custom Animations & Glassmorphism */
        body {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Scanning Animation */
        .scanner-container {
            position: relative;
            overflow: hidden;
        }
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #38bdf8; /* Cyan-400 */
            box-shadow: 0 0 10px #38bdf8, 0 0 20px #38bdf8;
            animation: scan 2s linear infinite;
            display: none; /* Hidden by default */
            z-index: 10;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Markdown Styles */
        .markdown-body { color: #e2e8f0; line-height: 1.6; }
        .markdown-body h1, .markdown-body h2 { color: #f8fafc; font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body code { background: rgba(255,255,255,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
        .markdown-body pre { background: #1e293b; padding: 1em; border-radius: 8px; overflow-x: auto; margin: 1em 0; }
        
        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(100%); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="min-h-screen text-slate-200 p-4 md:p-8 flex flex-col items-center">

    <header class="w-full max-w-2xl mb-8 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                <i class="fa-solid fa-eye text-white text-lg"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white">Vision AI</h1>
                <p class="text-xs text-slate-400">Powered by Gemini 2.5 Flash</p>
            </div>
        </div>
        
        <div class="relative group">
            <button id="settingsBtn" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                <i class="fa-solid fa-gear text-slate-400"></i>
            </button>
        </div>
    </header>

    <main class="w-full max-w-2xl flex flex-col gap-6">

        <div id="apiKeySection" class="glass-panel rounded-2xl p-4 transition-all duration-300">
            <label class="block text-xs font-semibold text-slate-400 mb-2 uppercase tracking-wider">API Configuration</label>
            <div class="relative">
                <input type="password" id="apiKeyInput" placeholder="Paste your Gemini API Key here" 
                    class="w-full bg-slate-900/50 border border-slate-700 text-slate-200 text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block p-3 pr-10 placeholder-slate-600 outline-none transition-all">
                <button id="toggleKeyBtn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-500 hover:text-cyan-400 cursor-pointer">
                    <i class="fa-regular fa-eye-slash" id="eyeIcon"></i>
                </button>
            </div>
        </div>

        <div class="glass-panel rounded-3xl p-1 overflow-hidden">
            <div id="dropZone" class="scanner-container relative w-full h-64 md:h-80 bg-slate-900/40 rounded-t-[20px] flex flex-col items-center justify-center border-b border-white/5 group cursor-pointer transition-colors hover:bg-slate-900/60">
                
                <div id="uploadPlaceholder" class="flex flex-col items-center text-slate-500 group-hover:text-slate-400 transition-colors">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl mb-3"></i>
                    <p class="text-sm font-medium">Tap to Upload or Drag Image</p>
                </div>

                <img id="imagePreview" class="hidden w-full h-full object-contain z-10" alt="Preview" />
                
                <div id="scannerLine" class="scanner-line"></div>
                
                <div id="loadingOverlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm z-20 hidden flex-col items-center justify-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-400 mb-3"></div>
                    <p class="text-cyan-400 text-sm font-mono animate-pulse">ANALYZING...</p>
                </div>
            </div>

            <div class="p-4 flex flex-col gap-4">
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('cameraInput').click()" 
                        class="flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-200 font-medium transition-all border border-slate-700 hover:border-slate-500">
                        <i class="fa-solid fa-camera"></i> Camera
                    </button>
                    <button onclick="document.getElementById('galleryInput').click()" 
                        class="flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-200 font-medium transition-all border border-slate-700 hover:border-slate-500">
                        <i class="fa-regular fa-image"></i> Gallery
                    </button>
                </div>

                <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" onchange="handleImage(this)">
                <input type="file" id="galleryInput" accept="image/*" class="hidden" onchange="handleImage(this)">

                <div class="relative">
                    <input type="text" id="promptInput" placeholder="Ask something about this image..." 
                        class="w-full bg-slate-900/50 border border-slate-700 text-slate-200 text-sm rounded-xl focus:ring-cyan-500 focus:border-cyan-500 block p-4 pr-12 outline-none transition-all">
                    
                    <button id="sendBtn" class="absolute inset-y-1 right-1 w-10 h-10 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-600 flex items-center justify-center text-white hover:shadow-lg hover:shadow-cyan-500/30 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="outputSection" class="glass-panel rounded-2xl p-6 hidden animate-[fadeIn_0.5s_ease-out]">
            <div class="flex items-center justify-between mb-4 pb-2 border-b border-white/10">
                <h3 class="text-sm font-bold text-cyan-400 uppercase tracking-wider"><i class="fa-solid fa-robot mr-2"></i>AI Analysis</h3>
                <span id="modelBadge" class="text-[10px] bg-cyan-500/10 text-cyan-400 px-2 py-1 rounded border border-cyan-500/20">GEMINI 2.5</span>
            </div>
            <div id="markdownOutput" class="markdown-body text-sm text-slate-300"></div>
        </div>

    </main>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-3 bg-slate-800 border border-amber-500/50 text-white px-4 py-3 rounded-xl shadow-2xl shadow-black/50 transition-all duration-300 transform translate-y-24 opacity-0 z-50">
        <div class="w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-500">
            <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <div>
            <h4 class="text-sm font-bold text-amber-500">System Fallback</h4>
            <p class="text-xs text-slate-300">Switched to Stable Model (1.5)</p>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const ELEMENTS = {
            apiKeyInput: document.getElementById('apiKeyInput'),
            toggleKeyBtn: document.getElementById('toggleKeyBtn'),
            eyeIcon: document.getElementById('eyeIcon'),
            imagePreview: document.getElementById('imagePreview'),
            uploadPlaceholder: document.getElementById('uploadPlaceholder'),
            dropZone: document.getElementById('dropZone'),
            scannerLine: document.getElementById('scannerLine'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            promptInput: document.getElementById('promptInput'),
            sendBtn: document.getElementById('sendBtn'),
            outputSection: document.getElementById('outputSection'),
            markdownOutput: document.getElementById('markdownOutput'),
            modelBadge: document.getElementById('modelBadge'),
            toast: document.getElementById('toast')
        };

        let currentImageBase64 = null;
        let currentMimeType = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) ELEMENTS.apiKeyInput.value = savedKey;
        });

        // --- Event Listeners ---
        ELEMENTS.apiKeyInput.addEventListener('input', (e) => {
            localStorage.setItem('gemini_api_key', e.target.value);
        });

        ELEMENTS.toggleKeyBtn.addEventListener('click', () => {
            const type = ELEMENTS.apiKeyInput.type === 'password' ? 'text' : 'password';
            ELEMENTS.apiKeyInput.type = type;
            ELEMENTS.eyeIcon.className = type === 'password' ? 'fa-regular fa-eye-slash' : 'fa-regular fa-eye';
        });

        ELEMENTS.sendBtn.addEventListener('click', executeAnalysis);
        
        ELEMENTS.dropZone.addEventListener('click', () => {
            if(!currentImageBase64) document.getElementById('galleryInput').click();
        });

        // --- Image Handling ---
        function handleImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // Update UI
                ELEMENTS.imagePreview.src = e.target.result;
                ELEMENTS.imagePreview.classList.remove('hidden');
                ELEMENTS.uploadPlaceholder.classList.add('hidden');
                
                // Store Data
                const base64String = e.target.result.split(',')[1];
                currentImageBase64 = base64String;
                currentMimeType = file.type;
                
                // Reset Output
                ELEMENTS.outputSection.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // --- API & Fallback Logic ---
        async function executeAnalysis() {
            const apiKey = ELEMENTS.apiKeyInput.value.trim();
            if (!apiKey) {
                alert("Please enter your Gemini API Key.");
                return;
            }
            if (!currentImageBase64) {
                alert("Please select an image first.");
                return;
            }

            const promptText = ELEMENTS.promptInput.value || "Describe this image in detail.";
            
            // UI Loading State
            setLoading(true);

            // 1. Construct the System Instruction & Payload
            // Note: We use the prompt text to reinforce the system instruction 
            // to ensure it works across different model versions cleanly.
            const finalPrompt = `
                SYSTEM INSTRUCTION: Detect the language of the image text/context. 
                Answer in the SAME language. Use Markdown formatting and LaTeX for math.
                
                USER QUERY: ${promptText}
            `;

            const requestBody = {
                contents: [{
                    parts: [
                        { text: finalPrompt },
                        { inline_data: { mime_type: currentMimeType, data: currentImageBase64 } }
                    ]
                }]
            };

            // 2. The Fallback Mechanism
            // Try 2.5 Flash -> Catch -> Try 1.5 Flash
            try {
                // PRIMARY ATTEMPT: Gemini 2.5 Flash
                console.log("Attempting Primary Model: gemini-2.5-flash");
                await callGeminiAPI("gemini-2.5-flash", apiKey, requestBody);
                updateBadge("GEMINI 2.5");
            
            } catch (error) {
                console.warn("Primary model failed:", error);
                
                // Show Toast
                showToast();

                // FALLBACK ATTEMPT: Gemini 1.5 Flash
                try {
                    console.log("Attempting Fallback Model: gemini-1.5-flash");
                    await callGeminiAPI("gemini-1.5-flash", apiKey, requestBody);
                    updateBadge("GEMINI 1.5 (STABLE)");
                } catch (fallbackError) {
                    console.error("Fallback failed:", fallbackError);
                    ELEMENTS.markdownOutput.innerHTML = `<span class="text-red-400">Error: ${fallbackError.message}</span>`;
                    ELEMENTS.outputSection.classList.remove('hidden');
                }
            } finally {
                setLoading(false);
            }
        }

        // Generic Fetch Function
        async function callGeminiAPI(model, key, body) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            
            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                // Throw error to trigger catch block
                throw new Error(errData.error?.message || `HTTP ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                renderResponse(text);
            } else {
                throw new Error("No content generated.");
            }
        }

        // --- Helper Functions ---

        function setLoading(isLoading) {
            if (isLoading) {
                ELEMENTS.loadingOverlay.classList.remove('hidden');
                ELEMENTS.loadingOverlay.classList.add('flex');
                ELEMENTS.scannerLine.style.display = 'block';
                ELEMENTS.sendBtn.disabled = true;
            } else {
                ELEMENTS.loadingOverlay.classList.add('hidden');
                ELEMENTS.loadingOverlay.classList.remove('flex');
                ELEMENTS.scannerLine.style.display = 'none';
                ELEMENTS.sendBtn.disabled = false;
            }
        }

        function renderResponse(markdown) {
            // Parse Markdown
            const rawHtml = marked.parse(markdown);
            ELEMENTS.markdownOutput.innerHTML = rawHtml;
            ELEMENTS.outputSection.classList.remove('hidden');

            // Render Math (LaTeX)
            renderMathInElement(ELEMENTS.markdownOutput, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError : false
            });
        }

        function showToast() {
            ELEMENTS.toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => {
                ELEMENTS.toast.classList.add('translate-y-24', 'opacity-0');
            }, 4000);
        }

        function updateBadge(text) {
            ELEMENTS.modelBadge.innerText = text;
            if(text.includes("1.5")) {
                ELEMENTS.modelBadge.className = "text-[10px] bg-amber-500/10 text-amber-500 px-2 py-1 rounded border border-amber-500/20";
            } else {
                ELEMENTS.modelBadge.className = "text-[10px] bg-cyan-500/10 text-cyan-400 px-2 py-1 rounded border border-cyan-500/20";
            }
        }
    </script>
</body>
</html>
