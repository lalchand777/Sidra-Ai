<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Private AI Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    background: #0b1120;
  }
</style>
</head>
<body class="text-white h-screen flex flex-col">

<!-- HEADER -->
<header class="bg-black border-b border-blue-900 p-4 flex justify-between items-center">
  <h1 class="text-lg font-semibold text-blue-400">DeepSeek Private AI</h1>
  <button id="settingsBtn" class="text-blue-400 hover:text-blue-300">⚙️</button>
</header>

<!-- CHAT AREA -->
<main id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4"></main>

<!-- INPUT -->
<div class="p-4 bg-black border-t border-blue-900 flex gap-2">
  <input id="userInput" type="text" placeholder="Type your message..."
    class="flex-1 p-3 rounded bg-gray-900 border border-blue-800 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
  <button id="sendBtn"
    class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-500 transition">
    Send
  </button>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal"
  class="fixed inset-0 bg-black bg-opacity-70 hidden justify-center items-center">

  <div class="bg-gray-900 p-6 rounded-lg w-11/12 max-w-md space-y-4">
    <h2 class="text-xl text-blue-400 font-semibold">Settings</h2>
    
    <input id="hfToken" type="password"
      placeholder="Enter Hugging Face Token"
      class="w-full p-3 rounded bg-gray-800 border border-blue-700 focus:outline-none"/>

    <p class="text-sm text-gray-400">
      Get Free Token from 
      <a href="https://huggingface.co/settings/tokens" target="_blank"
         class="text-blue-400 underline">huggingface.co/settings/tokens</a>
    </p>

    <div class="flex justify-end gap-2">
      <button id="closeSettings"
        class="px-4 py-2 bg-gray-700 rounded">Cancel</button>
      <button id="saveSettings"
        class="px-4 py-2 bg-blue-600 rounded">Save</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"
  class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-blue-700 px-4 py-2 rounded hidden">
</div>

<script>
const API_URL = "https://api-inference.huggingface.co/models/deepseek-ai/DeepSeek-R1-Distill-Qwen-32B";

const chatContainer = document.getElementById("chatContainer");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const settingsBtn = document.getElementById("settingsBtn");
const settingsModal = document.getElementById("settingsModal");
const hfTokenInput = document.getElementById("hfToken");
const saveSettings = document.getElementById("saveSettings");
const closeSettings = document.getElementById("closeSettings");
const toast = document.getElementById("toast");

let hfToken = localStorage.getItem("hf_token") || "";
hfTokenInput.value = hfToken;

function showToast(message) {
  toast.innerText = message;
  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 3000);
}

function addMessage(text, sender) {
  const bubble = document.createElement("div");
  bubble.className = sender === "user"
    ? "text-right"
    : "text-left";

  bubble.innerHTML = `
    <div class="inline-block px-4 py-3 rounded-lg max-w-[80%] ${
      sender === "user"
        ? "bg-blue-600 text-white"
        : "bg-gray-800 text-gray-100"
    }">
      ${text}
    </div>
  `;

  chatContainer.appendChild(bubble);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addTypingIndicator() {
  const typing = document.createElement("div");
  typing.id = "typing";
  typing.className = "text-left";
  typing.innerHTML = `
    <div class="inline-block px-4 py-3 rounded-lg bg-gray-800 text-gray-300">
      DeepSeek is thinking...
    </div>
  `;
  chatContainer.appendChild(typing);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

function removeTypingIndicator() {
  const typing = document.getElementById("typing");
  if (typing) typing.remove();
}

async function queryHF(prompt, retry = true) {
  const response = await fetch(API_URL, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + hfToken,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      inputs: prompt,
      options: { wait_for_model: false }
    })
  });

  if (response.status === 503 && retry) {
    showToast("Waking up the AI...");
    await new Promise(res => setTimeout(res, 5000));
    return queryHF(prompt, false);
  }

  const result = await response.json();

  if (result.error) {
    throw new Error(result.error);
  }

  return result[0]?.generated_text || "No response.";
}

async function handleSend() {
  const message = userInput.value.trim();
  if (!message) return;
  if (!hfToken) {
    showToast("Please set your Hugging Face token in Settings.");
    return;
  }

  addMessage(message, "user");
  userInput.value = "";
  addTypingIndicator();

  try {
    const aiResponse = await queryHF(message);
    removeTypingIndicator();
    addMessage(aiResponse.replace(message, ""), "ai");
  } catch (err) {
    removeTypingIndicator();
    addMessage("Error: " + err.message, "ai");
  }
}

sendBtn.onclick = handleSend;
userInput.addEventListener("keypress", e => {
  if (e.key === "Enter") handleSend();
});

settingsBtn.onclick = () => settingsModal.classList.remove("hidden");
closeSettings.onclick = () => settingsModal.classList.add("hidden");

saveSettings.onclick = () => {
  hfToken = hfTokenInput.value.trim();
  localStorage.setItem("hf_token", hfToken);
  settingsModal.classList.add("hidden");
  showToast("Token Saved Successfully");
};
</script>

</body>
</html>
