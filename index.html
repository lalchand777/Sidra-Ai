<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Viva Master - Premium Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Pulse Animation for Mic */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .mic-active { animation: pulse-ring 2s infinite; }
        
        /* Markdown-like styling for AI responses */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-slate-800 to-black text-white min-h-screen flex items-center justify-center p-4">

    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl p-8 w-full max-w-lg shadow-2xl transform transition-all scale-100">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 text-cyan-400">
                <i class="fa-solid fa-cog"></i> Configuration
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-2">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" placeholder="Paste your API Key here..." 
                            class="w-full bg-slate-900 border border-slate-600 rounded-xl p-4 text-white focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all">
                        <button onclick="toggleKeyVisibility()" class="absolute right-4 top-4 text-slate-400 hover:text-white">
                            <i class="fa-solid fa-eye" id="eyeIcon"></i>
                        </button>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Key is stored locally in your browser.</p>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-4">
                <button onclick="closeSettings()" class="px-6 py-2 rounded-xl text-slate-300 hover:bg-slate-700 transition-colors">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-xl shadow-lg shadow-cyan-500/30 transition-all">Save Key</button>
            </div>
        </div>
    </div>

    <div class="w-full max-w-4xl mx-auto">
        
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                    <i class="fa-solid fa-robot text-2xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold tracking-tight">AI Viva Master</h1>
                    <p class="text-slate-400 text-sm md:text-base">Professional Interview Simulator</p>
                </div>
            </div>
            <button onclick="openSettings()" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl transition-all border border-slate-700 group">
                <i class="fa-solid fa-gear text-xl text-slate-400 group-hover:text-cyan-400 transition-colors"></i>
            </button>
        </header>

        <div id="setupCard" class="bg-slate-800/50 backdrop-blur-md border border-slate-700 rounded-3xl p-6 md:p-10 shadow-2xl">
            
            <div class="space-y-8">
                <div>
                    <label class="block text-lg font-semibold text-slate-200 mb-3">Interview Topic</label>
                    <input type="text" id="topicInput" placeholder="e.g., React JS, Thermodynamics, World History..." 
                        class="w-full bg-slate-900/80 border border-slate-600 rounded-xl p-5 text-lg md:text-xl text-white placeholder-slate-500 focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all shadow-inner">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Interviewer Persona</label>
                        <div class="grid grid-cols-2 gap-3 p-1 bg-slate-900 rounded-xl border border-slate-700">
                            <button onclick="setMode('friendly')" id="btnFriendly" class="py-3 px-4 rounded-lg text-sm font-medium transition-all bg-emerald-600 text-white shadow-lg">
                                <i class="fa-solid fa-smile mr-2"></i>Friendly
                            </button>
                            <button onclick="setMode('strict')" id="btnStrict" class="py-3 px-4 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white">
                                <i class="fa-solid fa-user-tie mr-2"></i>Strict
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Language</label>
                        <div class="grid grid-cols-2 gap-3 p-1 bg-slate-900 rounded-xl border border-slate-700">
                            <button onclick="setLang('en-US')" id="btnEn" class="py-3 px-4 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white shadow-lg">
                                üá∫üá∏ English
                            </button>
                            <button onclick="setLang('hi-IN')" id="btnHi" class="py-3 px-4 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white">
                                üáÆüá≥ Hindi
                            </button>
                        </div>
                    </div>
                </div>

                <button onclick="startViva()" class="w-full py-5 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold text-xl rounded-xl shadow-lg shadow-blue-500/25 transform hover:scale-[1.01] transition-all flex items-center justify-center gap-3">
                    <span>Start Interview</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div id="interfaceCard" class="hidden bg-slate-800/50 backdrop-blur-md border border-slate-700 rounded-3xl overflow-hidden shadow-2xl flex flex-col h-[600px]">
            
            <div class="bg-slate-900/80 p-4 border-b border-slate-700 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-white text-lg" id="displayTopic">Topic</h3>
                    <span class="text-xs text-cyan-400 uppercase tracking-widest font-semibold" id="displayMode">Live Session</span>
                </div>
                <button onclick="endSession()" class="px-4 py-2 bg-red-500/10 text-red-400 border border-red-500/50 hover:bg-red-500 hover:text-white rounded-lg text-sm font-medium transition-all">
                    End Session
                </button>
            </div>

            <div id="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide">
                <div class="flex justify-start">
                    <div class="bg-slate-700/50 text-slate-200 p-4 rounded-2xl rounded-tl-none max-w-[80%] border border-slate-600">
                        <p class="text-sm text-slate-400 mb-1">AI Interviewer</p>
                        <p>Initializing interview environment...</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 p-6 border-t border-slate-700">
                <div class="flex items-center gap-4">
                    <button id="micBtn" onclick="toggleMic()" class="h-16 w-16 rounded-full bg-slate-800 border-2 border-slate-600 flex items-center justify-center text-white hover:bg-slate-700 hover:border-cyan-500 transition-all shadow-lg">
                        <i class="fa-solid fa-microphone text-2xl"></i>
                    </button>
                    
                    <div class="flex-1 relative">
                        <input type="text" id="userResponse" placeholder="Type or speak your answer..." 
                            class="w-full bg-slate-800 border border-slate-600 rounded-xl pl-5 pr-14 py-4 text-white focus:ring-2 focus:ring-cyan-500 outline-none">
                        <button onclick="sendMessage()" class="absolute right-2 top-2 bottom-2 aspect-square bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg flex items-center justify-center transition-all">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <p id="statusText" class="text-center text-xs text-slate-500 mt-3 font-mono">Ready to listen...</p>
            </div>
        </div>

    </div>

    <script>
        // --- Configuration State ---
        let config = {
            apiKey: '',
            topic: '',
            mode: 'friendly', // friendly | strict
            lang: 'en-US',    // en-US | hi-IN
            isRecording: false
        };

        let chatHistory = []; // To store context
        
        // --- Web Speech API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;

        const synth = window.speechSynthesis;

        // --- Initialization ---
        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) {
                config.apiKey = savedKey;
                document.getElementById('apiKeyInput').value = savedKey;
            }
        };

        // --- UI Functions ---
        
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if(!key) {
                alert("Please enter a valid API Key.");
                return;
            }
            localStorage.setItem('gemini_api_key', key);
            config.apiKey = key;
            closeSettings();
            alert("API Key saved securely!");
        }

        function toggleKeyVisibility() {
            const input = document.getElementById('apiKeyInput');
            const icon = document.getElementById('eyeIcon');
            if(input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function setMode(mode) {
            config.mode = mode;
            // Visual toggle
            const btnFriendly = document.getElementById('btnFriendly');
            const btnStrict = document.getElementById('btnStrict');
            
            if(mode === 'friendly') {
                btnFriendly.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all bg-emerald-600 text-white shadow-lg";
                btnStrict.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            } else {
                btnStrict.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all bg-purple-600 text-white shadow-lg";
                btnFriendly.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            }
        }

        function setLang(lang) {
            config.lang = lang;
            recognition.lang = lang;
            
            const btnEn = document.getElementById('btnEn');
            const btnHi = document.getElementById('btnHi');

            if(lang === 'en-US') {
                btnEn.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all bg-blue-600 text-white shadow-lg";
                btnHi.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            } else {
                btnHi.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all bg-orange-600 text-white shadow-lg";
                btnEn.className = "py-3 px-4 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white";
            }
        }

        // --- Core Application Logic ---

        function startViva() {
            // 1. Validate API Key
            if (!config.apiKey) {
                alert("‚ö†Ô∏è Configuration Error:\nPlease click the ‚öôÔ∏è icon (top right) and enter your Gemini API Key first.");
                openSettings();
                return;
            }

            // 2. Validate Topic (FIXED: Targeted correct ID and logic)
            const topicInput = document.getElementById('topicInput');
            const topicValue = topicInput.value.trim();

            if (!topicValue) {
                alert("‚ö†Ô∏è Input Error:\nPlease enter a Viva Topic to start (e.g., 'React JS', 'History').");
                topicInput.focus();
                return;
            }

            config.topic = topicValue;

            // UI Transition
            document.getElementById('setupCard').classList.add('hidden');
            document.getElementById('interfaceCard').classList.remove('hidden');
            
            // Update Interface Header
            document.getElementById('displayTopic').innerText = config.topic;
            document.getElementById('displayMode').innerText = config.mode.toUpperCase() + " MODE";

            // Initialize Chat
            initializeAI();
        }

        function endSession() {
            if(confirm("Are you sure you want to end the session?")) {
                location.reload();
            }
        }

        // --- AI Interaction ---

        async function initializeAI() {
            addMessage("system", "Connecting to AI Examiner...");
            
            const initialPrompt = `
                Act as a ${config.mode} viva examiner. 
                Topic: ${config.topic}. 
                Language: ${config.lang === 'hi-IN' ? 'Hindi (Hinglish allowed)' : 'English'}.
                
                Instructions:
                1. Start by introducing yourself and asking the first question about the topic.
                2. Keep questions concise (max 2 sentences).
                3. If mode is "Strict", be formal and tough. If "Friendly", be encouraging.
                4. Wait for user answer.
            `;

            await callGemini(initialPrompt, true);
        }

        async function sendMessage() {
            const input = document.getElementById('userResponse');
            const text = input.value.trim();
            
            if(!text) return;

            addMessage("user", text);
            input.value = '';
            
            await callGemini(text, false);
        }

        async function callGemini(userText, isSystemInit = false) {
            document.getElementById('statusText').innerText = "AI is thinking...";
            
            // Construct context for the API
            // In a real app, you'd manage history tokens carefully. Here we append simply.
            if(!isSystemInit) {
                chatHistory.push({ role: "user", parts: [{ text: userText }] });
            } else {
                 // System prompt logic typically goes in the first message or system instruction
                 // For this simple implementation, we send it as the first user part
                 chatHistory.push({ role: "user", parts: [{ text: userText }] });
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${config.apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Add AI response to history
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                
                addMessage("ai", aiResponse);
                speak(aiResponse);
                document.getElementById('statusText').innerText = "Waiting for your answer...";

            } catch (error) {
                console.error(error);
                addMessage("system", "Error: " + error.message);
                document.getElementById('statusText').innerText = "Connection Error";
            }
        }

        function addMessage(role, text) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = "flex w-full mb-4 " + (role === 'user' ? "justify-end" : "justify-start");
            
            let bgClass = role === 'user' ? "bg-cyan-600 text-white rounded-br-none" : "bg-slate-700/50 text-slate-200 rounded-tl-none border border-slate-600";
            if(role === 'system') bgClass = "bg-red-500/20 text-red-300 border border-red-500/50 text-center w-full justify-center";

            div.innerHTML = `
                <div class="${bgClass} p-4 rounded-2xl max-w-[85%] md:max-w-[70%] shadow-md prose">
                    ${role !== 'system' ? `<p class="text-xs opacity-70 mb-1 capitalize">${role === 'model' ? 'Interviewer' : 'You'}</p>` : ''}
                    <div>${text}</div>
                </div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Voice Logic ---

        function toggleMic() {
            if(config.isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        recognition.onstart = () => {
            config.isRecording = true;
            const btn = document.getElementById('micBtn');
            btn.classList.add('mic-active', 'bg-red-600', 'border-red-400');
            btn.classList.remove('bg-slate-800');
            document.getElementById('statusText').innerText = "Listening...";
        };

        recognition.onend = () => {
            config.isRecording = false;
            const btn = document.getElementById('micBtn');
            btn.classList.remove('mic-active', 'bg-red-600', 'border-red-400');
            btn.classList.add('bg-slate-800');
            document.getElementById('statusText').innerText = "Processing voice...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('userResponse').value = transcript;
            sendMessage(); // Auto-send on voice end
        };

        function speak(text) {
            if (synth.speaking) synth.cancel();
            
            // Clean text (remove asterisks etc used for markdown) for smoother speech
            const cleanText = text.replace(/[*#]/g, ''); 
            
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            // Try to match language voice
            const voices = synth.getVoices();
            if(config.lang === 'hi-IN') {
                const hindiVoice = voices.find(v => v.lang.includes('hi'));
                if(hindiVoice) utterance.voice = hindiVoice;
            }
            
            utterance.lang = config.lang;
            utterance.rate = 1;
            synth.speak(utterance);
        }

    </script>
</body>
</html>
